<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="ow.png" type="image/png" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OWDLE - Overwatch 2 Character Guessing Game - Guess</title>
  <style>
    @font-face {
      font-family: 'CrimsonText';
      src: url('big_noodle_titling_oblique.ttf') format('truetype');
    }

    body {
      font-family: Arial, sans-serif;
      background: url('ow2.png') no-repeat center center fixed;
      background-size: cover;
      color: #f0f0f0;
      text-align: center;
      padding: 20px;
    }

    input { padding: 10px; font-size: 16px; width: 260px; }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
      border: 2px solid #FFA500;
      border-radius: 6px;
      background-color: #111;
      color: #FFA500;
      box-shadow: 0 0 8px rgba(255, 165, 0, 0.7);
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }

    button:hover {
      background-color: #FFA500;
      color: #111;
      box-shadow: 0 0 14px rgba(255, 165, 0, 1);
    }

    table {
      margin: 20px auto;
      border-collapse: collapse;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      overflow: hidden;
    }
    h1 {
      font-family: 'CrimsonText';
      font-size: 45px;
      margin: 0;
      user-select: none;
      text-shadow: 0 0 10px #FFA500;
    }
    th, td { border: 1px solid #555; padding: 10px 14px; }
    .green { background-color: #4caf50; }
    .red { background-color: #f44336; }
    .yellow {
        background-color: #FFA500;
    }
    .name-cell {
      gap: 8px;
      padding: 10px 14px;
    }
    .name-cell img {
      align-self: center; /* keep image vertically centered */
      flex-shrink: 0;     /* prevent image shrinking */
    }
    .name-cell .name-text {
      flex-grow: 1;
      white-space: normal;  /* allow wrapping */
    }



    .hero-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    #message { margin-top: 10px; min-height: 22px; }
    #homeButton {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 8px 16px;
      background-color: #111;
      color: #FFA500;
      font-weight: bold;
      font-family: Arial, sans-serif;
      border: 2px solid #FFA500;
      border-radius: 6px;
      text-decoration: none;
      box-shadow: 0 0 8px rgba(255, 165, 0, 0.7);
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      z-index: 1000;
    }

    #homeButton:hover {
      background-color: #FFA500;
      color: #111;
      box-shadow: 0 0 14px rgba(255, 165, 0, 1);
    }

    .button-link {
      display: inline-block;
      padding: 10px 20px;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
      border: 2px solid #FFA500;
      border-radius: 6px;
      background-color: #111;
      color: #FFA500;
      box-shadow: 0 0 8px rgba(255, 165, 0, 0.7);
      text-decoration: none;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }

    .button-link:hover {
      background-color: #FFA500;
      color: #111;
      box-shadow: 0 0 14px rgba(255, 165, 0, 1);
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      input, .button-link, #guessBtn {
        width: 100%;
        box-sizing: border-box;
        font-size: 16px;
        margin: 8px 0;
      }

      table {
        width: 100%;
        font-size: 14px;
      }

      th, td {
        padding: 8px;
      }

      #dropdown {
        max-height: 150px;
      }

      .name-cell img {
        width: 24px;
        height: 24px;
      }

      h1 {
        font-size: 32px;
      }

      #homeButton {
        position: fixed;
        top: 10px;
        left: 10px;
        font-size: 14px;
        padding: 6px 12px;
      }

      .button-link {
        font-size: 16px;
        padding: 12px;
      }
    }
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3506454622942858"
     crossorigin="anonymous"></script>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T0DQQYCB56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T0DQQYCB56');
</script>

<body>
  <a href="https://www.owdle.xyz/" id="homeButton">Home</a>
  <h1><br/>OWDLE - Guess the Overwatch 2 Hero</h1>
  <div style="position: relative; display: inline-block; width: 260px; font-family: 'Orbitron', sans-serif;">
    <input type="text" id="guessInput" placeholder="Enter hero name" autocomplete="off"
      style="width: 100%; padding: 10px 12px; border: 2px solid #FFA500; border-radius: 6px; background-color: #111; color: #fff; font-size: 16px; box-shadow: 0 0 8px rgba(255,165,0,0.6); outline: none;">
    <ul id="dropdown"
      style="position: absolute; top: 100%; left: 0; right: 0; background: #1b1b1b; color: white; list-style: none; padding: 0; margin: 4px 0 0; border: 2px solid #FFA500; border-radius: 6px; max-height: 200px; overflow-y: auto; display: none; z-index: 999; box-shadow: 0 4px 12px rgba(255,165,0,0.5);">
    </ul>
  </div>
  <button id="guessBtn">Guess</button>
  <p id="message"></p>
  <div style="overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch;">
    <table id="resultsTable">
      <tr>
        <th>Name</th>
        <th>Role</th>
        <th>Affiliation</th>
        <th>Gender</th>
        <th>Species</th>
        <th>Nationality</th>
        <th>Year</th>
      </tr>
    </table>
  </div>

  <a href="/owdle-phrase.html" id="nextBtn" class="button-link">NEXT</a>
  <button id="shareBtn" style="margin-left: 10px;">Share</button>
  <footer style="position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 14px; color: #FFA500; font-family: Arial, sans-serif; text-shadow: 0 0 4px #000;">
  www.owdle.xyz
  </footer>
  <script>
    let guesses = [];
    let characters = [];
    let secretCharacter = null;

    async function loadGameData() {
      shareBtn.style.display = 'none';  // hide initially
      try {
        const shareBtn = document.getElementById('shareBtn');

        const charactersResponse = await fetch('characters.json');
        if (!charactersResponse.ok) throw new Error('Failed to load characters.json');
        characters = await charactersResponse.json();
        console.log('Characters loaded:', characters);

        const secretResponse = await fetch('data.json?v=' + Date.now());
        if (!secretResponse.ok) throw new Error('Failed to load data.json');
        const secretData = await secretResponse.json();
        console.log('Raw secret data:', secretData);

        // Check if secretCharacter exists in parsed JSON
        if (!secretData.secretCharacter) {
          console.error('secretCharacter not found in data.json!');
        }

        secretCharacter = secretData.secretCharacter;
        console.log('Secret character loaded:', secretCharacter);
      } catch (error) {
        console.error('Failed to load game data:', error);
      }
    }


    loadGameData();


    const guessInput = document.getElementById('guessInput');
    const guessBtn   = document.getElementById('guessBtn');
    const messageEl  = document.getElementById('message');

    guessBtn.addEventListener('click', checkGuess);
    

    const slugify  = name => name.toLowerCase().replace(/[^a-z0-9]/g, '');
    const getIconUrl = name => `./icons/${slugify(name)}.webp`;


    let isCheckingGuess = false;

      function checkGuess() {
        const guess = guessInput.value.trim();
        const character = characters.find(c => c.name.toLowerCase() === guess.toLowerCase());

        if (!character) {
          messageEl.textContent = '❌ Hero not found!';
          messageEl.style.color = '#ff5252';
          return;
        }

        // Добавляем в guesses для построения итоговой таблицы
        guesses.push(character);

        const table = document.getElementById('resultsTable');
        const row = table.insertRow();
        const fields = ['name', 'role', 'affiliation', 'gender', 'species', 'nationality', 'releaseYear'];

        fields.forEach(field => {
          const cell = row.insertCell();

          if (field === 'name') {
            cell.classList.add('name-cell');
            const img = document.createElement('img');
            img.src = getIconUrl(character.name);
            img.alt = `${character.name} icon`;
            img.className = 'hero-icon';
            const span = document.createElement('span');
            span.textContent = character.name;
            cell.append(img, span);
            cell.classList.add(character.name === secretCharacter.name ? 'green' : 'red');
          }
          else if (field === 'releaseYear') {
            let text = character.releaseYear;
            if (character.releaseYear === secretCharacter.releaseYear) {
              cell.className = 'green';
            } else {
              cell.className = 'red';
              text += character.releaseYear < secretCharacter.releaseYear ? ' ↑' : ' ↓';
            }
            cell.textContent = text;
          }
          else {
            const guessValue = String(character[field]).toLowerCase();
            const secretValue = String(secretCharacter[field]).toLowerCase();

            function wordPartialMatch(a, b) {
              const wordsA = a.split(/\s+/);
              const wordsB = b.split(/\s+/);
              return wordsA.some(word => b.includes(word)) || wordsB.some(word => a.includes(word));
            }

            if (guessValue === secretValue) {
              cell.className = 'green';
            } else if (field !== 'gender' && wordPartialMatch(guessValue, secretValue)) {
              cell.className = 'yellow';
            } else {
              cell.className = 'red';
            }

            cell.textContent = character[field];
          }
        });

        if (character.name === secretCharacter.name) {
          messageEl.textContent = '🎉 Correct! You guessed the hero.';
          messageEl.style.color = '#4caf50';
          shareBtn.style.display = 'inline-block';
        }
      }

      // Функция для формирования строки эмодзи по цветам ячеек в строке таблицы
      function getEmojiForCell(cell) {
        if (cell.classList.contains('green')) return '🟩';
        if (cell.classList.contains('yellow')) return '🟧';
        if (cell.classList.contains('red')) return '🟥';
        return '⬜'; // если вдруг без класса
      }

      // Формируем строку с эмодзи по одной попытке (одна строка таблицы)
      function formatGuessRow(row) {
        // пропускаем первый столбец с именем (у него нет эмодзи, но он тоже покрашен)
        let emojis = '';
        for(let i=1; i < row.cells.length; i++) {
          const cell = row.cells[i];
          let emoji = getEmojiForCell(cell);
          // добавим стрелки для releaseYear ↑ или ↓ (которые есть в тексте)
          if (cell.textContent.includes('↑')) emoji = '⬆️';
          if (cell.textContent.includes('↓')) emoji = '⬇️';
          emojis += emoji;
        }
        return emojis;
      }

      // Обработчик кнопки Share
      document.getElementById('shareBtn').addEventListener('click', () => {
        if (guesses.length === 0) {
          alert('Make at least one guess before sharing!');
          return;
        }
        const table = document.getElementById('resultsTable');
        const rows = table.rows;

        // Найдём номер сегодняшнего чемпионата (просто пример, тут можно добавить логику)
        const mode = 'classic';
        const attempts = guesses.length;

        // Сложность можно определить как "easy" если попыток <=4, иначе "hard"
        const difficulty = attempts <= 4 ? 'easy' : 'hard';

        // Формируем заголовок
        let text = `I guessed #Owdle champion in ${mode} mode on try ${attempts} ⚔️\n`;

        // Добавляем эмодзи строки для каждой попытки (пропуская заголовок)
        for(let i=1; i < rows.length; i++) {
          text += formatGuessRow(rows[i]) + '\n';
        }

        text += '\nhttps://owdle.xyz';

        // Копируем в буфер
        navigator.clipboard.writeText(text).then(() => {
          alert('Results copied to clipboard! Share it anywhere 😊');
        }).catch(() => {
          alert('Failed to copy results. Please copy manually:\n\n' + text);
        });
      });

    const dropdown = document.getElementById('dropdown');

    guessInput.addEventListener('input', () => {

      const input = guessInput.value.toLowerCase();
      dropdown.innerHTML = '';

      if (input.length === 0) {
        dropdown.style.display = 'none';
        return;
      }

      const filtered = characters.filter(c => c.name.toLowerCase().includes(input));
      filtered.forEach(char => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.padding = '10px 12px';
        li.style.cursor = 'pointer';
        li.style.borderBottom = '1px solid #333';
        li.style.transition = 'background 0.2s ease, transform 0.1s ease';

        const img = document.createElement('img');
        img.src = getIconUrl(char.name);
        img.alt = `${char.name} icon`;
        img.style.width = '32px';
        img.style.height = '32px';
        img.style.borderRadius = '50%';
        img.style.objectFit = 'cover';
        img.style.marginRight = '10px';
        li.appendChild(img);

        const span = document.createElement('span');
        span.textContent = char.name;
        li.appendChild(span);

        li.addEventListener('mouseover', () => {
          li.style.background = '#333';
          li.style.transform = 'translateX(4px)';
        });
        li.addEventListener('mouseout', () => {
          li.style.background = 'transparent';
          li.style.transform = 'none';
        });
        li.addEventListener('click', () => {
          guessInput.value = char.name;
          dropdown.style.display = 'none';
          checkGuess();
        });
        dropdown.appendChild(li);
      });

      dropdown.style.display = filtered.length ? 'block' : 'none';
    });


    let activeIndex = -1;

    guessInput.addEventListener('keydown', e => {
      const items = dropdown.querySelectorAll('li');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        activeIndex = (activeIndex + 1) % items.length;
        updateDropdownFocus(items);
        e.preventDefault();
      } else if (e.key === 'ArrowUp') {
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        updateDropdownFocus(items);
        e.preventDefault();
      } else if (e.key === 'Enter') {
        if (activeIndex !== -1) {
          // Set input to selected dropdown name manually
          guessInput.value = items[activeIndex].querySelector('span').textContent;
          dropdown.style.display = 'none';
          checkGuess(); // call once here manually
          activeIndex = -1; // reset
          e.preventDefault();
        } else {
          checkGuess();
          e.preventDefault();
        }
      }
    });


    function updateDropdownFocus(items) {
      items.forEach((item, index) => {
        if (index === activeIndex) {
          item.style.background = '#444';
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.style.background = 'transparent';
        }
      });
    }


    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && e.target !== guessInput) {
        dropdown.style.display = 'none';
        activeIndex = -1;
      }
      activeIndex = -1
    });



  </script>
</body>
</html>
